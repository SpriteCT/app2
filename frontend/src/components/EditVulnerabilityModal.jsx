import React, { useState, useEffect } from 'react'
import { vulnerabilitiesApi, referenceApi } from '../services/api'
import { transformVulnerability, transformVulnerabilityToBackend } from '../utils/dataTransform'

const EditVulnerabilityModal = ({
  isOpen,
  onClose,
  onUpdate,
  vulnerability,
  assets = [],
  scanners = []
}) => {
  const [editVuln, setEditVuln] = useState(null)
  const [vulnStatuses, setVulnStatuses] = useState([])
  const [priorityLevels, setPriorityLevels] = useState([])

  useEffect(() => {
    if (isOpen) {
      const loadReferenceData = async () => {
        try {
          const [statuses, priorities] = await Promise.all([
            referenceApi.getVulnStatuses(),
            referenceApi.getPriorityLevels(),
          ])
          setVulnStatuses(statuses)
          setPriorityLevels(priorities)
        } catch (error) {
          console.error('Failed to load reference data:', error)
        }
      }
      loadReferenceData()
    }
  }, [isOpen])

  useEffect(() => {
    if (vulnerability) {
      setEditVuln({ ...vulnerability })
    }
  }, [vulnerability])

  const handleSave = async () => {
    if (!editVuln) return
    
    try {
      const backendData = transformVulnerabilityToBackend(editVuln)
      const updated = await vulnerabilitiesApi.update(editVuln.id, backendData)
      const transformed = transformVulnerability(updated)
      onUpdate(transformed)
      onClose()
    } catch (error) {
      console.error('Failed to update vulnerability:', error)
      alert('Ошибка при обновлении уязвимости')
    }
  }

  if (!isOpen || !editVuln) return null

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
      <div className="bg-dark-surface border border-dark-border rounded-lg max-w-2xl w-full">
        <div className="border-b border-dark-border px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold text-white">Редактировать уязвимость</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-white transition-colors">✕</button>
        </div>
        <div className="p-6 space-y-4">
          <div>
            <label className="text-sm text-gray-400 mb-2 block">Название</label>
            <input 
              type="text" 
              value={editVuln.title} 
              onChange={(e) => setEditVuln({ ...editVuln, title: e.target.value })} 
              className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary" 
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-sm text-gray-400 mb-2 block">Актив</label>
              <select 
                value={editVuln.assetId || ''} 
                onChange={(e) => setEditVuln({ ...editVuln, assetId: e.target.value ? parseInt(e.target.value) : null })}
                className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary"
              >
                <option value="">— выберите актив —</option>
                {assets.filter(a => !editVuln.clientId || String(a.clientId) === String(editVuln.clientId)).map(a => (
                  <option key={a.id} value={a.id}>{a.name}</option>
                ))}
              </select>
            </div>
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-sm text-gray-400 mb-2 block">Критичность</label>
              <select 
                value={editVuln.criticalityId || ''} 
                onChange={(e) => setEditVuln({ ...editVuln, criticalityId: e.target.value ? parseInt(e.target.value) : null })} 
                className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary"
              >
                <option value="">— выберите критичность —</option>
                {priorityLevels.map(priority => (
                  <option key={priority.id} value={priority.id}>{priority.name}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="text-sm text-gray-400 mb-2 block">CVSS</label>
              <input 
                type="number" 
                min="0" 
                max="10" 
                step="0.1" 
                value={editVuln.cvss || ''} 
                onChange={(e) => {
                  const val = parseFloat(e.target.value)
                  if (!isNaN(val) && val >= 0 && val <= 10) {
                    setEditVuln({ ...editVuln, cvss: val })
                  } else if (e.target.value === '') {
                    setEditVuln({ ...editVuln, cvss: '' })
                  }
                }} 
                className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary" 
              />
            </div>
          </div>
          <div>
            <label className="text-sm text-gray-400 mb-2 block">CVE</label>
            <input 
              type="text" 
              value={editVuln.cve || ''} 
              onChange={(e) => setEditVuln({ ...editVuln, cve: e.target.value })} 
              className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary" 
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-sm text-gray-400 mb-2 block">Статус</label>
              <select 
                value={editVuln.statusId || ''} 
                onChange={(e) => setEditVuln({ ...editVuln, statusId: e.target.value ? parseInt(e.target.value) : null })} 
                className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary"
              >
                <option value="">— выберите статус —</option>
                {vulnStatuses.map(status => (
                  <option key={status.id} value={status.id}>{status.name}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="text-sm text-gray-400 mb-2 block">Сканер</label>
              <select 
                value={editVuln.scannerId || ''} 
                onChange={(e) => setEditVuln({ ...editVuln, scannerId: e.target.value ? parseInt(e.target.value) : null })} 
                className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary"
              >
                <option value="">— выберите сканер —</option>
                {scanners.map(s => (
                  <option key={s.id} value={s.id}>{s.name}</option>
                ))}
              </select>
            </div>
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-sm text-gray-400 mb-2 block">Обнаружена</label>
              <input 
                type="date" 
                value={editVuln.discovered || ''} 
                onChange={(e) => setEditVuln({ ...editVuln, discovered: e.target.value })} 
                className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary" 
              />
            </div>
            <div>
              <label className="text-sm text-gray-400 mb-2 block">Изменена</label>
              <input 
                type="date" 
                value={editVuln.lastModified || ''} 
                onChange={(e) => setEditVuln({ ...editVuln, lastModified: e.target.value })} 
                className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary" 
              />
            </div>
          </div>
          <div>
            <label className="text-sm text-gray-400 mb-2 block">Описание</label>
            <textarea 
              rows="4" 
              value={editVuln.description || ''} 
              onChange={(e) => setEditVuln({ ...editVuln, description: e.target.value })} 
              className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary" 
            />
          </div>
          <div className="flex justify-end gap-3">
            <button 
              onClick={onClose} 
              className="px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg hover:bg-dark-border transition-colors"
            >
              Отмена
            </button>
            <button 
              onClick={handleSave} 
              className="px-4 py-2 bg-dark-purple-primary text-white rounded-lg hover:bg-dark-purple-secondary transition-colors"
            >
              Сохранить
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

export default EditVulnerabilityModal

