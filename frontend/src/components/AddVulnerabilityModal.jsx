import React, { useState, useMemo } from 'react'
import { vulnerabilitiesApi } from '../services/api'
import { transformVulnerability, transformVulnerabilityToBackend } from '../utils/dataTransform'

const AddVulnerabilityModal = ({
  isOpen,
  onClose,
  onCreate,
  clients = [],
  assets = [],
  scanners = []
}) => {
  const [newVuln, setNewVuln] = useState({
    title: '',
    clientId: '',
    assetId: null,
    scannerId: null,
    criticality: 'High',
    status: 'Open',
    cvss: null,
    cve: '',
    description: '',
  })
  const [assetSearch, setAssetSearch] = useState('')

  const filteredAssets = useMemo(() => {
    const term = assetSearch.toLowerCase()
    return assets.filter(a => {
      const matchesTerm = a.name.toLowerCase().includes(term)
      const matchesClient = !newVuln.clientId || String(a.clientId) === String(newVuln.clientId)
      return matchesTerm && matchesClient
    })
  }, [assetSearch, assets, newVuln.clientId])

  const handleCreate = async () => {
    // Validation
    if (!newVuln.title || !newVuln.title.trim()) {
      alert('Пожалуйста, укажите название уязвимости')
      return
    }
    if (!newVuln.clientId) {
      alert('Пожалуйста, выберите клиента')
      return
    }
    
    // Валидация CVSS
    if (newVuln.cvss !== null && newVuln.cvss !== undefined && newVuln.cvss !== '') {
      const cvssValue = parseFloat(newVuln.cvss)
      if (isNaN(cvssValue) || cvssValue < 0 || cvssValue > 10) {
        alert('CVSS должен быть числом от 0 до 10')
        return
      }
    }
    
    try {
      const backendData = transformVulnerabilityToBackend(newVuln)
      const created = await vulnerabilitiesApi.create(backendData)
      const transformed = transformVulnerability(created)
      onCreate(transformed)
      onClose()
      setNewVuln({
        title: '',
        clientId: '',
        assetId: null,
        scannerId: null,
        criticality: 'High',
        status: 'Open',
        cvss: null,
        cve: '',
        description: '',
      })
      setAssetSearch('')
    } catch (error) {
      console.error('Failed to create vulnerability:', error)
      alert(`Ошибка при создании уязвимости: ${error.message}`)
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
      <div className="bg-dark-surface border border-dark-border rounded-lg max-w-2xl w-full">
        <div className="border-b border-dark-border px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold text-white">Добавить уязвимость вручную</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-white transition-colors"
          >
            ✕
          </button>
        </div>
        
        <div className="p-6 space-y-4">
          <div>
            <label className="text-sm text-gray-400 mb-2 block">Название</label>
            <input
              type="text"
              value={newVuln.title}
              onChange={(e) => setNewVuln({ ...newVuln, title: e.target.value })}
              className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary"
              placeholder="Введите название уязвимости"
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-sm text-gray-400 mb-2 block">Клиент</label>
              <select 
                value={newVuln.clientId} 
                onChange={(e) => setNewVuln({ ...newVuln, clientId: e.target.value ? parseInt(e.target.value) : '' })}
                className="w-full px-3 py-2 bg-dark-card border border-dark-border text-white rounded"
              >
                <option value="">— выберите клиента —</option>
                {clients.map(c => (
                  <option key={c.id} value={c.id}>{c.name}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="text-sm text-gray-400 mb-2 block">Актив</label>
              <div className="space-y-2">
                <input 
                  type="text" 
                  value={assetSearch} 
                  onChange={(e) => setAssetSearch(e.target.value)} 
                  placeholder="Поиск по активу..." 
                  className="w-full px-3 py-2 bg-dark-surface border border-dark-border text-white rounded" 
                />
                <select 
                  value={newVuln.assetId || ''} 
                  onChange={(e) => setNewVuln({ ...newVuln, assetId: e.target.value ? parseInt(e.target.value) : null })}
                  className="w-full px-3 py-2 bg-dark-card border border-dark-border text-white rounded"
                >
                  <option value="">— выберите актив —</option>
                  {filteredAssets.map(a => (
                    <option key={a.id} value={a.id}>{a.name}</option>
                  ))}
                </select>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-sm text-gray-400 mb-2 block">Критичность</label>
              <select 
                value={newVuln.criticality}
                onChange={(e) => setNewVuln({ ...newVuln, criticality: e.target.value })}
                className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary"
              >
                <option>Critical</option>
                <option>High</option>
                <option>Medium</option>
                <option>Low</option>
              </select>
            </div>
            <div>
              <label className="text-sm text-gray-400 mb-2 block">CVSS</label>
              <input
                type="number"
                step="0.1"
                max="10"
                min="0"
                value={newVuln.cvss || ''}
                onChange={(e) => setNewVuln({ ...newVuln, cvss: e.target.value ? parseFloat(e.target.value) : null })}
                className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary"
                placeholder="7.5"
              />
            </div>
          </div>

          <div>
            <label className="text-sm text-gray-400 mb-2 block">CVE</label>
            <input 
              type="text" 
              value={newVuln.cve}
              onChange={(e) => setNewVuln({ ...newVuln, cve: e.target.value })}
              placeholder="CVE-2021-44228" 
              className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary" 
            />
          </div>

          <div>
            <label className="text-sm text-gray-400 mb-2 block">Сканер</label>
            <select 
              value={newVuln.scannerId || ''}
              onChange={(e) => setNewVuln({ ...newVuln, scannerId: e.target.value ? parseInt(e.target.value) : null })}
              className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary"
            >
              <option value="">— выберите сканер —</option>
              {scanners.map(s => (
                <option key={s.id} value={s.id}>{s.name}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="text-sm text-gray-400 mb-2 block">Описание</label>
            <textarea
              rows="4"
              value={newVuln.description}
              onChange={(e) => setNewVuln({ ...newVuln, description: e.target.value })}
              className="w-full px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-dark-purple-primary"
              placeholder="Подробное описание уязвимости..."
            />
          </div>

          <div className="flex justify-end gap-3">
            <button
              onClick={onClose}
              className="px-4 py-2 bg-dark-card border border-dark-border text-white rounded-lg hover:bg-dark-border transition-colors"
            >
              Отмена
            </button>
            <button
              onClick={handleCreate}
              className="px-4 py-2 bg-dark-purple-primary text-white rounded-lg hover:bg-dark-purple-secondary transition-colors"
            >
              Добавить уязвимость
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

export default AddVulnerabilityModal

